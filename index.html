<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victron Live Dashboard</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
            background-color: #f0f2f5;
        }
        #loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2em;
            color: #555;
        }
        #dashboard-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            /* Start hidden until a valid URL is loaded */
            visibility: hidden;
        }
    </style>
</head>
<body>

    <div id="loader">
        <p>Connecting to live dashboard...</p>
    </div>

    <iframe id="dashboard-iframe" title="Victron Live Dashboard"></iframe>

    <script>
        const CHECK_INTERVAL_MS = 5000; // Check for a new URL every 5 seconds
        const URL_FILE = 'latest_url.txt';
        
        let currentUrl = null;
        const iframe = document.getElementById('dashboard-iframe');
        const loader = document.getElementById('loader');

        async function checkForNewUrl() {
            try {
                // Cache-bust by appending the current time to the URL
                const response = await fetch(`${URL_FILE}?t=${new Date().getTime()}`);
                if (!response.ok) {
                    console.error('Could not fetch the URL file.');
                    return;
                }
                
                const newUrl = (await response.text()).trim();

                // Check if the URL is valid and different from the current one
                if (newUrl && newUrl.startsWith('http') && newUrl !== currentUrl) {
                    console.log(`New destination found: ${newUrl}`);
                    currentUrl = newUrl;
                    
                    // Update the iframe source
                    iframe.src = currentUrl;
                    
                    // Hide loader and show iframe
                    loader.style.display = 'none';
                    iframe.style.visibility = 'visible';
                }
            } catch (error) {
                console.error('Error while checking for new URL:', error);
            }
        }

        // Start the periodic check
        setInterval(checkForNewUrl, CHECK_INTERVAL_MS);
        
        // Run once immediately on page load
        checkForNewUrl();
    </script>
</body>
</html>
